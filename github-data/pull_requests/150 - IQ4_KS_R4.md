## ðŸ”€ [Pull Request #150](https://github.com/ikawrakow/ik_llama.cpp/pull/150) - IQ4_KS_R4

| **Author** | `ikawrakow` |
| :--- | :--- |
| **State** | ðŸ”€ **Merged** |
| **Source Branch** | `ik/iq4_ks_r4` |
| **Target Branch** | `main` |
| **Created** | 2024-12-18 |
| **Updated** | 2024-12-18 |
| **Merged** | 2024-12-18 |

---

## ðŸ“„ Description

Adding `IQ4_KS` with 4 interleaved rows.

We get very signifiant performance gains on `ARM_NEON` and good gains on `AVX2/Zen4`. 

Here is `PP-512` for LLaMA-3.1-8B on `Zen4` (Ryzen-7950X), `ARM_NEON` (M2-Max) and `AVX2` (Ryzen-5975WX)

| Platform |  Threads | IQ4_KS | IQ4_KS_R4 | Speedup |
| ---: | ---: | ---: | ---: | ---: |
| ARM_NEON |  8 |  67.29 Â± 1.02  | 124.91 Â± 0.62 | 1.856 |
| Zen4            | 16 | 180.42 Â± 0.68 | 266.05 Â± 0.45  | 1.475 |
| AVX2           | 32 | 201.79 Â± 0.48 |  245.37 Â± 0.52  | 1.216 |

We get decent performance gains for TG as well.
Here results for TG-128 on LLaMA-3.1-8B with different numbers of threads:

| Platform |  Threads | IQ4_KS | IQ4_KS_R4 | Speedup |
| ---: | ---: | ---: | ---: | ---: |
| ARM_NEON | 2 |  10.84 Â± 0.01 | 12.55 Â± 0.00 | 1.158 |
|                      | 4 | 19.81 Â± 0.12 | 22.06 Â± 0.06 | 1.114 |
|                      | 8 | 25.74 Â± 0.47 | 26.47 Â± 0.21  | 1.039 |
| Zen4            | 1 |  6.18 Â± 0.00  | 7.97 Â± 0.11  |  1.290 |
|                      | 2 |  11.73 Â± 0.02 | 13.43 Â± 0.00  |  1.145 |
|                      | 4 |  13.09 Â± 1.13  | 14.46 Â± 0.00  |  1.105 |
| AVX2           | 2 | 4.74 Â± 0.00  | 7.30 Â± 0.00 | 1.540 |
|                     | 4 | 8.75 Â± 0.00  |  11.39 Â± 0.00 | 1.302 |
|                     | 8 |  12.38 Â± 0.01  | 12.73 Â± 0.00  | 1.028 |