## ðŸ”€ [Pull Request #162](https://github.com/ikawrakow/ik_llama.cpp/pull/162) - IQ3_S_R4

| **Author** | `ikawrakow` |
| :--- | :--- |
| **State** | ðŸ”€ **Merged** |
| **Source Branch** | `ik/iq3_s_r4_v2` |
| **Target Branch** | `main` |
| **Created** | 2024-12-23 |
| **Updated** | 2024-12-23 |
| **Merged** | 2024-12-23 |

---

## ðŸ“„ Description

Sub-4 bpw i-quants have a terrible CPU performance, so I was curious to see if we can improve by interleaving rows.

This PR adds `IQ3_S_R4`, a 4-row interleaved version of `IQ3_S`.

We get significant performance gains. Here is `PP-512` for LLaMA-3.1-8B on `Zen4` (Ryzen-7950X), `ARM_NEON` (M2-Max) and `AVX2` (Ryzen-5975WX)

| Platform |  Threads | IQ3_S | IQ3_S_R4 | Speedup |
| ---: | ---: | ---: | ---: | ---: |
| ARM_NEON |  8 |  42.97 Â± 1.28  | 80.61 Â± 0.41  | 1.876 |
| Zen4            | 16 | 104.66 Â± 0.68 | 159.08 Â± 0.57 | 1.520 |
| AVX2           | 32 | 132.50 Â± 0.37  |  231.41 Â± 0.45 | 1.746 |

We get decent performance gains for TG as well, especially on `AVX2`.
Here results for TG-128 on LLaMA-3.1-8B with different numbers of threads:

| Platform |  Threads | IQ3_S | IQ3_S_R4 | Speedup |
| ---: | ---: | ---: | ---: | ---: |
| ARM_NEON | 2 |  3.00 Â± 0.00  | 3.40 Â± 0.00 | 1.133 |
|                      | 4 | 5.74 Â± 0.02  | 6.60 Â± 0.01  | 1.150 |
|                      | 8 | 9.25 Â± 0.83 | 12.27 Â± 0.33  | 1.326 |
| Zen4            | 2 |  4.17 Â± 0.00  | 4.38 Â± 0.01 |  1.050 |
|                      | 4 |  7.82 Â± 0.05 | 8.14 Â± 0.01  |  1.041 |
|                      | 8 |  14.29 Â± 0.02  | 14.41 Â± 0.02 |  1.008 |
| AVX2           | 2 |  1.98 Â± 0.00  | 3.31 Â± 0.00 | 1.672 |
|                     | 4 | 3.87 Â± 0.00  |   6.49 Â± 0.00  | 1.677 |
|                     | 8 |  7.13 Â± 0.01  | 11.63 Â± 0.02  | 1.631 |
|                     | 16 |  12.97 Â± 0.00 |  15.81 Â± 0.00  | 1.219 |