## ðŸ”€ [Pull Request #149](https://github.com/ikawrakow/ik_llama.cpp/pull/149) - IQ5_K_R4

| **Author** | `ikawrakow` |
| :--- | :--- |
| **State** | ðŸ”€ **Merged** |
| **Source Branch** | `ik/iq5_k_r4` |
| **Target Branch** | `main` |
| **Created** | 2024-12-18 |
| **Updated** | 2025-03-27 |
| **Merged** | 2024-12-18 |

---

## ðŸ“„ Description

Adding `IQ5_K` with 4 interleaved rows.

We get very signifiant performance gains on `ARM_NEON` and more modest gains on `AVX2/Zen4`. 

Here is `PP-512` for LLaMA-3.1-8B on `Zen4` (Ryzen-7950X), `ARM_NEON` (M2-Max) and `AVX2` (Ryzen-5975WX)

| Platform |  Threads | IQ5_K | IQ5_K_R4 | Speedup |
| ---: | ---: | ---: | ---: | ---: |
| ARM_NEON |  8 |  53.80 Â± 1.08  |  93.33 Â± 2.02 | 1.735 |
| Zen4            | 16 | 168.09 Â± 0.58 | 230.23 Â± 0.23    | 1.370 |
| AVX2           | 32 | 177.16 Â± 0.31 |  231.50 Â± 0.43   | 1.307 |

TG does not look good on AVX2/Zen4. On ARM_NEON we get a decent performance gain.
Here results for TG-128 on LLaMA-3.1-8B with different numbers of threads:

| Platform |  Threads | IQ5_K | IQ5_K_R4 | Speedup |
| ---: | ---: | ---: | ---: | ---: |
| ARM_NEON | 2 |  5.92 Â± 0.07 | 6.98 Â± 0.00 | 1.179 |
|                      | 4 | 11.53 Â± 0.01  | 13.35 Â± 0.01 | 1.158 |
|                      | 8 | 20.29 Â± 0.46 | 21.17 Â± 0.18  | 1.043 |

---

## ðŸ’¬ Conversation

ðŸ‘¤ **saood06** commented on **2025-03-27** at **06:53:47**

>TG does not look good on AVX2/Zen4

Does this mean regression compared to non-interleaved or just no benefit?

---

ðŸ‘¤ **ikawrakow** commented on **2025-03-27** at **07:08:50**

I don't remember. But the "Better Zen4" commit in the PR says "But TG is still slower than iq5_k".